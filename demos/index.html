<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title></title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

    <script src="../src/jquery.emojiarea.poe.js"></script>
    <link rel="stylesheet" href="../src/assets/libs/jquery-emojiarea/jquery.emojiarea.css">
    <link rel="stylesheet" href="stylesheet.css">
    <link rel="stylesheet" href="../src/assets/libs/At.js/css/jquery.atwho.css" />
    
    <script src="../src/assets/libs/bootstrap-3.0.0/js/bootstrap.min.js"></script>
    <link href="../src/assets/libs/bootstrap-3.0.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="../src/assets/css/emojidex.css" rel="stylesheet">

    <script type="text/javascript" src="../src/assets/libs/At.js/js/jquery.atwho.js"></script>
    <script type="text/javascript" src="../src/assets/libs/Caret.js/src/jquery.caret.js"></script>
    <script src="../dist/jquery.emojidex.js"></script> 

    <script>
      $(document).ready(function(){
        $('.emojidex_replace').emojidex({
        	path_json: "../src/assets/json/utf-emoji_non_anime.json",
        	path_img: "../src/assets/img/utf/",
          emojiarea: {
            plaintext: $('.emojidex-plaintext'), //emojidex_plaintext
            wysiwyg: $('.emojidex-all'), //emojidex_wysiwyg
            value_output: $('.emojidex-value_output') //emojidex_rawtext
            //emojidex #all on (wysiwyg + controls)
            //emojidex_controls #button and controls are added
            //emojidex_wysiwyg #wysiwyg editor mode (controls not enabled by default, :->search enabled)
            //emojidex_plaintext #raw text, no graphics
          }
        });
      });
    </script>
  </head>
  <body>
  
    <h1>emojidex-coffee Example</h1>
    
    <div class="example">
      <h2>Emojidex replace</h2>
      <div class="emojidex_replace">
        🛅😄❤😡💌❤😈👍❤
        :octopus::boar::frog_face::test:
      </div>
    </div>

    <div class="example">
      <h2>Plain-Text</h2>
      <form>
        <textarea rows="5" class="emojidex-plaintext">Hello :neckbeard:</textarea>
      </form>
    </div>

    <div class="example">
      <!--
      <h2>WYSIWYG</h2>
      <form>
        <textarea rows="5" class="emojidex-all">Hello :neckbeard:</textarea>
      </form>
      -->
      <h2>Show Emoji Icon</h2>
      <div class="emojidex-all" contentEditable="true">
        Hello :neckbeard:
      </div>
      <h3>Value:</h3>
      <div class="value">
        <pre class="emojidex-value_output"></pre>
      </div>
    </div>

    <div class="imgArea">
      <script>

  (function() {

  // namespace
  window.cacheModule = window.cacheModule || {};

  // alias
  var aCacheModule = window.cacheModule;
  var storage = window.localStorage;

  // LocalStorageがサポートされているかの判定式
  var supportStorage = storage;

  var PREFIX = 'yoheimcache:';
  var version = '?ver=3.0.3';


  // バージョンが変わっている場合には、キャッシュを削除する。
  (function() {
    if (supportStorage) {
      var ver = storage.getItem('yoheimVersion');
      if (ver !== version) {
        storage.clear();
        storage.setItem('yoheimVersion', version);
      }
    }
  })();



  // localStorage用のキー生成
  var createKey = function(str) {return PREFIX + str + version;}
  // バージョン付きのURL
  var urlWithVersion = function(url) {return url + version;}


  // 引数の内容から、imgタグを生成する。
  var createImgTag = function(src, cssClass, options) {
      var tag = '<img src="' + (src || '') + '" class="' + (cssClass || '') + '" ';
      for (var prop in options) {
        if (options.hasOwnProperty(prop)) {
          tag += ' ' + prop + '="' + options[prop] + '"';
        }
      }
      tag += '/>';

      return tag;
  }


  /*
    画像のロード
  */
  aCacheModule.loadImage = function(src, cssClass, options) {
    options = options || {};

    if (!supportStorage) {
      // LocalStorageがサポートされていない場合は、imgタグを出力する
      document.write(createImgTag(src, cssClass, options));
      return;
    
    } else {

      // LocalStorageにキャッシュがある場合、その画像を表示する
      var base64 = storage.getItem(createKey(src));
      if (base64) {
        document.write(createImgTag(base64, cssClass, options));
        return;
      
      } else {

        // LocalStorageにキャッシュが無い場合は、imgタグを出力する
        document.write(createImgTag(src, cssClass, options));

        // そして、その後画像を別途取得して、LocalStorageへ保存しておく
        window.addEventListener('load', function() {

          var canvas = document.createElement("canvas");
          if (!canvas || !canvas.getContext || !canvas.getContext('2d')) {
            return;
          }
          var image = new Image();
          image.src = src;
          image.onload = function() {

            // 画像をbase64にするためにCanvasを利用するので、
            // クロスドメインの画像は無理かも。。
            var canvas = document.createElement("canvas");
            canvas.width = this.width;
            canvas.height = this.height;
            canvas.getContext('2d').drawImage(this, 0, 0);
            var base64 = canvas.toDataURL();

            storage.setItem(createKey(src), base64);
          };
        }, false);
      }
    }
  };
})();

window.cacheModule.loadImage('test.svg', 'someClass', {width: '50px', style:'float:right; padding-left:7px;'});
  </script>  
    </div>
 </body>

</html>